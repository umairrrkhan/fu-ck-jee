<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login / Sign Up - Hope  JEE.</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase config needed for auth functions -->
    <!-- <script type="module" src="firebase-config.js"></script> --> <!-- Not needed here if imported in module below -->
</head>
<body>
     <header>
        <nav class="navbar">
            <a href="index.html" class="brand">
                <span class="brand-logo"></span>
                Hope  JEE.
            </a>
            <!-- Header buttons to switch between Login/Signup view -->
            <div class="auth-buttons">
                 <!-- Initially show Signup, hide Login (since Login tab is default) -->
                 <a href="#signup" id="auth-nav-signup" class="nav-button signup-btn" onclick="openTab(event, 'signup', true)">Sign Up</a>
                 <a href="#login" id="auth-nav-login" class="nav-button login-btn" style="display: none;" onclick="openTab(event, 'login', true)">Login</a>
            </div>
        </nav>
    </header>

    <main class="auth-page-container">
        <div class="auth-container">

            <!-- Login Form -->
            <div id="login" class="tab-content active"> <!-- Default active tab -->
                <h2>Log in to Hope  JEE.</h2>
                <button class="google-btn" id="googleSignInBtn">
                    <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google logo" width="18" height="18">
                    Sign in with Google
                </button>
                <div class="auth-separator">Or continue with email</div>

                <form id="loginForm" class="auth-form">
                    <div class="form-group">
                        <input type="email" id="loginEmail" placeholder="Email address" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <input type="password" id="loginPassword" placeholder="Password" required autocomplete="current-password">
                    </div>
                    <!-- Add error message display area -->
                    <div id="loginError" class="error-message" style="display: none;"></div>
                    <button type="submit" class="auth-btn" id="loginSubmitBtn">Sign in</button>
                </form>
                <p class="auth-switch">Don't have an account? <a href="#signup" onclick="openTab(event, 'signup', true)">Sign up →</a></p>
            </div>

            <!-- Sign Up Form -->
            <div id="signup" class="tab-content">
                <h2>Create New Account</h2>
                <button class="google-btn" id="googleSignUpBtn">
                    <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google logo" width="18" height="18">
                    Continue with Google
                </button>
                <div class="auth-separator">Or continue with email</div>
                <form id="signupForm" class="auth-form">
                    <div class="form-group">
                        <input type="email" id="signupEmail" placeholder="Email address" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <input type="password" id="signupPassword" placeholder="Password (min. 6 characters)" required minlength="6" autocomplete="new-password">
                    </div>
                    <!-- Add error message display area -->
                    <div id="signupError" class="error-message" style="display: none;"></div>
                    <button type="submit" class="auth-btn" id="signupSubmitBtn">Sign Up</button>
                </form>
                <p class="auth-switch">Already have an account? <a href="#login" onclick="openTab(event, 'login', true)">Log in →</a></p>
            </div>
        </div>
    </main>

    <!-- Load general scripts FIRST -->
    <script src="script.js"></script>
    <!-- Load Firebase logic as a module -->
    <script type="module">
        // Import necessary Firebase functions
        import { signInWithGoogle, signInWithEmail, signUpWithEmail, onAuthStateChanged } from './firebase-config.js';

        // --- Get Form Elements and Error Displays ---
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const googleSignUpBtn = document.getElementById('googleSignUpBtn');
        const loginErrorDiv = document.getElementById('loginError');
        const signupErrorDiv = document.getElementById('signupError');
        const loginSubmitBtn = document.getElementById('loginSubmitBtn');
        const signupSubmitBtn = document.getElementById('signupSubmitBtn');

        // --- Utility to show errors ---
        function showLoginError(message) {
            loginErrorDiv.textContent = message;
            loginErrorDiv.style.display = 'block';
        }
        function showSignupError(message) {
            signupErrorDiv.textContent = message;
            signupErrorDiv.style.display = 'block';
        }
        function hideErrors() {
            loginErrorDiv.style.display = 'none';
            signupErrorDiv.style.display = 'none';
            loginErrorDiv.textContent = '';
            signupErrorDiv.textContent = '';
        }

        // --- Redirect if already logged in ---
        onAuthStateChanged((user) => {
            if (user) {
                console.log('User already logged in, redirecting from auth page to index.html');
                window.location.href = 'index.html'; // Or dashboard.html
            } else {
                console.log('User is not logged in. Showing auth page.');
                 // Make sure forms are enabled if previously disabled
                 if (loginSubmitBtn) loginSubmitBtn.disabled = false;
                 if (signupSubmitBtn) signupSubmitBtn.disabled = false;
                 if (googleSignInBtn) googleSignInBtn.disabled = false;
                 if (googleSignUpBtn) googleSignUpBtn.disabled = false;
            }
        });

        // --- Google Sign In Handlers ---
        const handleGoogleSignIn = async (buttonElement) => {
            hideErrors();
            buttonElement.disabled = true; // Disable button during process
            console.log('Attempting Google Sign-In...');
            try {
                const result = await signInWithGoogle();
                if (result.success) {
                    console.log('Google Sign-In successful. Redirecting...');
                    // Redirect handled by onAuthStateChanged
                } else {
                    console.error('Google Sign-In failed:', result.error, 'Code:', result.code);
                    showLoginError(result.error || 'Failed to sign in with Google. Please try again.');
                    buttonElement.disabled = false; // Re-enable button on failure
                }
            } catch (error) {
                console.error('Unexpected error during Google sign in:', error);
                showLoginError('An unexpected error occurred with Google Sign-In.');
                buttonElement.disabled = false; // Re-enable button on failure
            }
        };

        if (googleSignInBtn) {
            googleSignInBtn.addEventListener('click', () => handleGoogleSignIn(googleSignInBtn));
        }

        if (googleSignUpBtn) {
            googleSignUpBtn.addEventListener('click', () => handleGoogleSignIn(googleSignUpBtn));
        }

        // --- Email/Password Login Handler ---
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideErrors();
                loginSubmitBtn.disabled = true; // Disable button
                loginSubmitBtn.textContent = 'Signing in...';

                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;

                // Basic client-side validation (Firebase handles more)
                if (!email || !password) {
                    showLoginError('Please enter both email and password.');
                    loginSubmitBtn.disabled = false;
                    loginSubmitBtn.textContent = 'Sign in';
                    return;
                }

                console.log('Attempting Email/Password Login...');
                try {
                    const result = await signInWithEmail(email, password);
                    if (result.success) {
                        console.log('Email/Password Login successful. Redirecting...');
                        // Redirect handled by onAuthStateChanged
                    } else {
                        console.error('Email/Password Login failed:', result.error, 'Code:', result.code);
                        // Provide more specific feedback based on error code
                        if (result.code === 'auth/user-not-found' || result.code === 'auth/wrong-password' || result.code === 'auth/invalid-credential') {
                             showLoginError('Invalid email or password. Please try again.');
                        } else {
                            showLoginError(result.error || 'Login failed. Please check your credentials.');
                        }
                        loginSubmitBtn.disabled = false; // Re-enable button
                        loginSubmitBtn.textContent = 'Sign in';
                    }
                } catch (error) {
                    console.error('Unexpected error during Email/Password login:', error);
                    showLoginError('An unexpected error occurred during login.');
                    loginSubmitBtn.disabled = false; // Re-enable button
                    loginSubmitBtn.textContent = 'Sign in';
                }
            });
        }

        // --- Email/Password Sign Up Handler ---
        if (signupForm) {
            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideErrors();
                signupSubmitBtn.disabled = true; // Disable button
                signupSubmitBtn.textContent = 'Signing Up...';

                const email = document.getElementById('signupEmail').value.trim();
                const password = document.getElementById('signupPassword').value;

                // Client-side validation
                if (!email || !password) {
                    showSignupError('Please enter both email and password.');
                    signupSubmitBtn.disabled = false;
                    signupSubmitBtn.textContent = 'Sign Up';
                    return;
                }

                if (password.length < 6) {
                    showSignupError('Password must be at least 6 characters long.');
                    signupSubmitBtn.disabled = false;
                    signupSubmitBtn.textContent = 'Sign Up';
                    return;
                }

                console.log('Attempting Email/Password Sign Up...');
                try {
                    const result = await signUpWithEmail(email, password);
                    if (result.success) {
                        console.log('Email/Password Sign Up successful. Redirecting...');
                        // Redirect handled by onAuthStateChanged
                    } else {
                        console.error('Email/Password Sign Up failed:', result.error, 'Code:', result.code);
                        if (result.existingAccount) {
                            showSignupError('This email is already registered. Please log in instead.');
                        } else {
                            showSignupError(result.error || 'Sign up failed. Please try again.');
                        }
                        signupSubmitBtn.disabled = false;
                        signupSubmitBtn.textContent = 'Sign Up';
                    }
                } catch (error) {
                    console.error('Unexpected error during Email/Password sign up:', error);
                    showSignupError('An unexpected error occurred during sign up.');
                    signupSubmitBtn.disabled = false;
                    signupSubmitBtn.textContent = 'Sign Up';
                }
            });
        }

        // --- Initial Tab/UI Setup (Handled by DOMContentLoaded in script.js) ---
        // The DOMContentLoaded listener in script.js should handle calling
        // openTab and updateAuthHeaderButtons based on the initial hash.
    </script>
</body>
</html>